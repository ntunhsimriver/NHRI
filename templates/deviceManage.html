{% extends "base.html" %}

{% block title %}NHRI - 臨床研究數據平台{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='Content/css/deviceManage.css') }}">
{% endblock %}

{% block content %}
<!-- <section class="welcome">
  <h2>歡迎來到健康資料平台</h2>
  <p>探索病人的健康事件與醫療資訊。</p>
</section> -->

<section class="space-y-6 fade-in">
  <div class="flex flex-col justify-between gap-4 md:flex-row md:items-center">
    <div>
      <h2 class="text-2xl font-bold text-slate-900">設備管理模組</h2>
      <p class="text-sm text-slate-500">檢視與管理所有專案設備、配對狀態與資料同步情形</p>
    </div>
    <button class="flex items-center gap-2 rounded-lg bg-blue-600 px-4 py-2 text-sm font-medium text-white hover:bg-blue-700 shadow-sm shadow-blue-500/30"
      data-bs-toggle="modal" 
      data-bs-target="#Modal_addDevice">
      <i class="bi bi-gear"></i> 新增設備入庫
    </button>
  </div>
  <div class="grid gap-4 md:grid-cols-4">
    <div class="rounded-lg border border-slate-200 bg-white p-4 shadow-sm">
      <span class="text-xs text-slate-500">總設備數</span>
      <p class="text-2xl font-bold text-slate-900">{{TotalDev}}</p>
    </div>
    <div class="rounded-lg border border-slate-200 bg-white p-4 shadow-sm">
      <span class="text-xs text-slate-500">使用中 (In Use)</span>
      <p class="text-2xl font-bold text-blue-600">{{CountDev['active']}}</p>
    </div>
    <div class="rounded-lg border border-slate-200 bg-white p-4 shadow-sm">
      <span class="text-xs text-slate-500">庫存可用 (Available)</span>
      <p class="text-2xl font-bold text-emerald-600">{{CountDev['foundPat']}}</p>
    </div>
    <div class="rounded-lg border border-slate-200 bg-white p-4 shadow-sm">
      <span class="text-xs text-slate-500">異常/維修</span>
      <p class="text-2xl font-bold text-red-500">{{CountDev['entered-in-error']}}</p>
    </div>
  </div>
  <div class="overflow-hidden rounded-xl border border-slate-200 bg-white shadow-sm">

    <table class="w-full text-left text-sm">
      <thead class="bg-slate-50 text-slate-500 border-b border-slate-200">
        <tr>
          <th class="px-6 py-3 font-medium">型號 (Model)</th>
          <th class="px-6 py-3 font-medium">設備機碼 (SN)</th>
          <th class="px-6 py-3 font-medium">狀態</th>
          <th class="px-6 py-3 font-medium">綁定個案 Hash ID</th>
          <th class="px-6 py-3 font-medium">產出資料量</th>
          <th class="px-6 py-3 font-medium">最後同步</th>
          <th class="px-6 py-3 font-medium text-right">操作</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-slate-100">

        <!-- 迴圈開始 -->
        {% for item in data %}
        <tr class="hover:bg-slate-50 transition-colors">
          <td class="px-6 py-4 font-medium text-slate-900">{{item.model}}</td>
          <td class="px-6 py-4 font-mono text-slate-600">{{item.id}}</td>
          <td class="px-6 py-4">
            <span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium bg-blue-100 text-blue-800">{{item.status}}</span>
          </td>
          <td class="px-6 py-4">
            {% if item.pat_id %}
              <span class="font-mono text-blue-600 underline cursor-pointer">{{ item.pat_id }}</span>
            {% else %}
              <span class="text-slate-400">-</span>
            {% endif %}
          </td>
          <td class="px-6 py-4 text-slate-700">0 筆</td>
          <td class="px-6 py-4 text-slate-500 text-xs">2024-01-05 14:00</td>
          <td class="px-6 py-4 text-right">
            <button class="text-slate-400 hover:text-blue-600"
              data-bs-toggle="modal" 
              data-bs-target="#Modal_addDevice"
              data-bs-value='{{ {"id": item.id, "model": item.model, "status": item.status, "pat_id": item.pat_id} | tojson }}'>
              <i class="bi bi-gear"></i>
            </button>
          </td>
        </tr>
        {% endfor %}
        <!-- 迴圈結束 -->
      </tbody>
    </table>
  </div>

</section>

<!-- 新增使用者的彈跳視窗 開始 -->
<div class="modal fade" id="Modal_addDevice" tabindex="-1" aria-labelledby="Modal_addDevice_Label" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-md">
    <form id="registerForm" class="modal-content border-0 shadow-2xl rounded-xl">
      
      <div class="modal-header border-b border-slate-100 p-4">
        <h3 id="Modal_addDevice_title" class="text-lg font-bold text-slate-900">新增設備</h3>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div id="Modal_addDevice_body" class="p-6 space-y-6" style="max-height: 90vh; overflow: hidden;">
        <div id="message" class="message"></div>


        <label class="block text-sm font-medium text-slate-700" for="DeviceModel">設備型號</label>
        <select id="DeviceModel" class="mt-1 block w-full rounded-md !border !border-slate-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500" required>
          <option value="VivoWatch 5">VivoWatch 5</option>
          <option value="VivoWatch SP">VivoWatch SP</option>
          <option value="VivoWatch 5 HC">VivoWatch 5 HC</option>
        </select>

        <label class="block text-sm font-medium text-slate-700" for="DeviceId">設備序號 (SN) / MAC Address</label>
        <input type="text" id="DeviceId" class="mt-1 block w-full rounded-md px-3 py-2 text-sm !border !border-slate-300 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500" required>

        <label class="block text-sm font-medium text-slate-700" for="DeviceStatus">初始狀態</label>
        <select id="DeviceStatus" class="mt-1 block w-full rounded-md !border !border-slate-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500" required>
          <option value="active">active</option>
          <option value="inactive">inactive</option>
        </select>

        <label class="block text-sm font-medium text-slate-700" for="PatId">綁定個案(請填入FHIR id)</label>
        <input type="text" id="PatId" class="mt-1 block w-full rounded-md px-3 py-2 text-sm !border !border-slate-300 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500" placeholder="Patient/example" >

      </div>

      <div class="modal-footer border-t border-slate-100 p-3">
        <button type="button" class="mr-2 rounded-lg border border-slate-200 px-4 py-2 text-sm font-medium text-slate-600 hover:bg-slate-50" data-bs-dismiss="modal">取消</button>
        <button type="submit" class="rounded-lg bg-blue-600 px-4 py-2 text-sm font-medium text-white hover:bg-blue-700">更新設備</button>
      </div>
      
    </form>
  </div>
</div>
<!-- 新增使用者的彈跳視窗 結束 -->
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='Content/Scripts/deviceManage.js') }}"></script>
{% endblock %}
