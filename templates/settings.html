{% extends "base.html" %}

{% block title %}NHRI - 臨床研究數據平台{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='Content/css/settings.css') }}">
{% endblock %}

{% block content %}
<!-- <section class="welcome">
  <h2>歡迎來到健康資料平台</h2>
  <p>探索病人的健康事件與醫療資訊。</p>
</section> -->

<section>
  <div class="space-y-6 fade-in">
    <div class="flex flex-col justify-between gap-4 md:flex-row md:items-center">
      <div>
        <h2 class="text-2xl font-bold text-slate-900">系統管理</h2>
        <p class="text-sm text-slate-500">管理使用者帳號、角色權限與系統參數</p>
      </div>
      <button class="flex items-center gap-2 rounded-lg bg-blue-600 px-4 py-2 text-sm font-medium text-white hover:bg-blue-700 shadow-sm shadow-blue-500/30" 
        data-bs-toggle="modal" 
        data-bs-target="#Modal_addUser" >
        <i class="bi bi-plus"></i> 新增使用者
      </button>
    </div>
    <div class="rounded-xl border border-slate-200 bg-white shadow-sm overflow-hidden">
      <div class="border-b border-slate-200 px-6 py-4">
        <h3 class="font-semibold text-slate-900">帳號列表 (User Management)</h3>
      </div>
      <table class="w-full text-left text-sm">
        <thead class="bg-slate-50 text-slate-500 border-b border-slate-200">
          <tr>
            <th class="px-6 py-3 font-medium">姓名</th>
            <th class="px-6 py-3 font-medium">Email</th>
            <th class="px-6 py-3 font-medium">角色權限</th>
            <th class="px-6 py-3 font-medium">狀態</th>
            <th class="px-6 py-3 font-medium">最後登入</th>
            <th class="px-6 py-3 font-medium text-right">操作</th>
          </tr>
        </thead>

        <tbody class="divide-y divide-slate-100">
          
          <!-- 迴圈開始 -->
          {% for item in users %}
          <tr class="hover:bg-slate-50">
            <td class="px-6 py-4 font-medium text-slate-900">{{item.full_name}}</td>
            <td class="px-6 py-4 text-slate-600">{{item.email}}</td>
            <td class="px-6 py-4">
              <span class="inline-flex items-center gap-1 rounded-full px-2.5 py-0.5 text-xs font-medium  type-{{item.role.name}}">
                <i class="bi bi-shield"></i> {{item.role.name}} ({{item.roleName}})</span>
              </td>
              <td class="px-6 py-4">
                <span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium bg-emerald-100 text-emerald-800">Active</span>
              </td>
              <td class="px-6 py-4 text-slate-500 text-xs">2024-05-20 09:00</td>
              <td class="px-6 py-4 text-right">
                <button class="text-blue-600 hover:text-blue-800 font-medium text-xs"
                    data-bs-toggle="modal" 
                    data-bs-target="#Modal_addUser"
                    data-bs-value='{{ {"full_name": item.full_name, "email": item.email, "roleName": item.role.name, "org": item.organization, "pra_id": item.fhir_practitioner_id} | tojson }}'
                    > 
                編輯</button>
              </td>
            </tr>
            {% endfor %}
            <!-- 迴圈結束 -->
          </tbody>
        </table>
      </div>
    </div>

</section>

<!-- 新增使用者的彈跳視窗 開始 -->
<div class="modal fade" id="Modal_addUser" tabindex="-1" aria-labelledby="Modal_addUser_Label" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-md">
    <form id="registerForm" class="modal-content border-0 shadow-2xl rounded-xl">
      
      <div class="modal-header border-b border-slate-100 p-4">
        <h3 id="Modal_addUser_title" class="text-lg font-bold text-slate-900">新增使用者帳號</h3>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div id="Modal_addUser_body" class="p-6 space-y-6" style="max-height: 90vh; overflow: hidden;">
        <div id="message" class="message"></div>

        <label class="block text-sm font-medium text-slate-700" for="newUser_name">姓名</label>
        <input type="text" id="newUser_name" class="mt-1 block w-full rounded-md px-3 py-2 text-sm !border !border-slate-300 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500" required>
        
        <label class="block text-sm font-medium text-slate-700" for="newUser_email">Email (帳號)</label>
        <input type="email" id="newUser_email" class="mt-1 block w-full rounded-md px-3 py-2 text-sm !border !border-slate-300 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500" required>

        <label class="block text-sm font-medium text-slate-700" for="newUser_org">隸屬單位</label>
        <input type="text" id="newUser_org" class="mt-1 block w-full rounded-md px-3 py-2 text-sm !border !border-slate-300 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500" required>

        <!-- 是否有已知的PraId，有才填，沒有就算了 -->
        <label class="block text-sm font-medium text-slate-700" for="newUser_PraId">是否有已知的Practitioner ID(若無則可留空)</label>
        <input type="text" id="newUser_PraId" placeholder="Practitioner/Pra-test-id" class="mt-1 block w-full rounded-md px-3 py-2 text-sm !border !border-slate-300 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500">

        <label class="block text-sm font-medium text-slate-700" for="newUser_role">角色權限</label>
        <select id="newUser_role" class="mt-1 block w-full rounded-md !border !border-slate-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500" required>
          <option value="PI">PI (計畫主持人)</option>
          <option value="ASSISTANT">PI 助理</option>
          <option value="SUPER_ADMIN">系統管理員 (Super Admin)</option>
        </select>

      </div>

      <div class="modal-footer border-t border-slate-100 p-3">
        <button type="button" class="mr-2 rounded-lg border border-slate-200 px-4 py-2 text-sm font-medium text-slate-600 hover:bg-slate-50" data-bs-dismiss="modal">取消</button>
        <button type="submit" class="rounded-lg bg-blue-600 px-4 py-2 text-sm font-medium text-white hover:bg-blue-700">建立帳號</button>
      </div>
      
    </form>
  </div>
</div>
<!-- 新增使用者的彈跳視窗 結束 -->
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='Content/Scripts/settings.js') }}">
</script>
{% endblock %}
